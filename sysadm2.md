# Домашнее задание к занятию "3.7. Компьютерные сети, лекция 2"
1. - Проверьте список доступных сетевых интерфейсов на вашем компьютере. Какие команды есть для этого в Linux и в Windows?

В Windows утилита 'ipconfig'. В Linux утилита 'ip link'; можно добавить ключи -c -br для подсветки и короткого вывода

2. - Какой протокол используется для распознавания соседа по сетевому интерфейсу? Какой пакет и команды есть в Linux для этого?

LLDP — протокол канального уровня, позволяющий сетевому оборудованию оповещать оборудование, работающее в локальной сети, о своём существовании и передавать ему свои характеристики, а также получать от него аналогичные сведения.
На сервере надо установить пакет 'lldpd', настроить файл 'lldpd.service', включить сервис и запустить на срвере: 
```
systemctl enable lldpd
systemctl start lldpd
```
И используя утилиту 'lldpctl' смотреть кто подключен на интерфес.

3. - Какая технология используется для разделения L2 коммутатора на несколько виртуальных сетей? Какой пакет и команды есть в Linux для этого? Приведите пример конфига.

VLAN – это аббревиатура, означающая Virtual Local Area Network (виртаульная локальная сеть). На одном физическом порту может совместно существовать несколько VLAN-сетей, которые настраиваются программными средствами Linux, а не конфигурацией физических интерфейсов (но настройка самих интерфейсов тоже требуется). С помощью VLAN можно разделить сетевые ресурсы для использования различных сервисов.
Чтобы использовать VLAN надо:
Коммутатор с поддержкой стандарта IEEE 802.1q в сети Ethernet.
Сетевая карта, которая работает с Linux и поддерживает стандарт 802.1q
Сначала проверим, что драйвер (модуль) ядра Linux под названием 8021 загружен:
```
lsmod | grep 8021q
8021q                  32768  0
garp                   16384  1 8021q
mrp                    20480  1 8021q

```
Если он не загружен, загрузим его командой modprobe:
```
modprobe 8021q
```
Далее можно задать vlan вручную, исправив файл: 
sudo nano /etc/network/interfaces
```
##vlan с ID-100 для интерфейса eth0 with ID - 100 в Debian/Ubuntu Linux##
auto eth0.100
iface eth0.100 inet static
address 192.168.1.200
netmask 255.255.255.0
vlan-raw-device eth0
```
auto eth0.100 — «поднимать» интерфейс при запуске сетевой службы
iface eth0.100 — название интерфейса
vlan-raw-device— указывает на каком физическом интерфейсе создавать VLAN.

Сохраните и закройте файл. После чего перезапустите сеть.
```
systemctl restart network
```

Можно утилитой 'vconfig', она входит в комплкт 'vlan':
```
vconfig add eth0 5
```
Команда vconfig add создает на интерфейсе eth0 VLAN-устройство, в результате чего появляется интерфейс eth0.5.
Однако утилита устарела. Прелагают использовать утилиту 'ip' с опцией 'link' из пакета 'iproute2'с таким синтаксисом:
```
sudo ip link add link DEVNAME name VLANNAME type vlan id VLAN-ID reorder_hdr on|off loose_binding on|off gvrp on|off ingress-qos-map FROM:TO egress-qos-map FROM:TO
```
При включенной опции **reorder-header** (по умолчанию включена) кадры, проходящие через интерфейс VLAN, не содержат тегов. При отключенной опции, в кадрах сохраняется тег.
Опция **loose-binding** отвечает за синхронизацию состояния VLAN-интерфейса с базовым интерфейсом. По-умолчанию, отключена, и при переключении базового интерфейса в состояние down состояние VLAN-интерфейса так же меняется на down. При включении, состояние VLAN-интерфейса не зависит от состояния базового интерфейса.
Опция **gvrp** отвечает за то, распространять ли информацию о данном VLAN по протоколу gvrp. Для поддержки этой опции должна быть поддержка данной возможности со стороны ядра.
Опции **ingress-qos-map** и **egress-qos-map** задают трансляцию между полем приоритета заголовка 802.1q и приоритетом структуры skb (данное поле используется в системе управления трафиком). Следует учитывать, что поле приоритета VLAN-заголовка имеет размер 3 бита и может принимать значения от 0 до 7. Размер же поля приоритета структуры skb составляет 32 бита.

Просмотр vlan
```
ip -details link show dev VLANNAME
```
Для изменения параметров VLAN-интерфейса используется команда ip link set, с обязательным указанием type vlan.
```
sudo ip link set dev VLANNAME type vlan OPTION VALUE
```
Удаление VLAN-интерфейса
```
sudo ip link del VLANNAME
```
Дополнительная информация содержится в справочной странице man ip link.

Теперь осталось задать ip адрес для нового интерфейса.

Для получения подробной информации об интерфейсе выполните:
```
cat /proc/net/vlan/eth0.5
```

4. - Какие типы агрегации интерфейсов есть в Linux? Какие опции есть для балансировки нагрузки? Приведите пример конфига.

Агрегирование каналов может быть настроено между двумя коммутаторами, коммутатором и маршрутизатором, между коммутатором и хостом. Есть еще распределённое агрегирование, например технология M-LAG. Тема очень обширная.

Есть статический и динамический link aggregation (lag). Статический просто подразумевает что конфигурация на обоих концах одинакова и устройства не будут обмениваться между собой информацией о состоянии каналов и т.п..
Динамическое агрегирование каналов поддерживает standby порты, которые позволяют настраивать резервные порты, на случай если один из портов в агрегированном канале выйдет из строя.

Если рассматривать избыточные соединения между коммутаторами, то без использования специальных технологий для агрегирования каналов, передаваться данные будут только через один интерфейс, который не заблокирован STP. Такой вариант позволяет обеспечить резервирование каналов, но не дает возможности увеличить пропускную способность.

**LAG может обнаруживать только разъединения входящих в него каналов, но не может обнаруживать другие сбои, такие как сбои канального уровня и неправильные соединения каналов. Лучше использовать LACP, если это возможно.**

Хотя агрегирование каналов позволяет увеличить пропускную способность канала, не стоит рассчитывать на балансировку нагрузки между интерфейсами в агрегированном канале. Технологии по балансировке нагрузки в агрегированных каналах, как правило, ориентированы на балансировку по таким критериям: MAC-адресам, IP-адресам, портам отправителя или получателя (по одному критерию или их комбинации). То есть, реальная загруженность конкретного интерфейса никак не учитывается. Для балансировки нагрузки лучше использовать внешние средства.

Режимы балансировки (RHEL и CentOS):

Режим 0 (balance-rr) : этот режим также известен как циклический режим. Пакеты последовательно передаются и принимаются через каждый интерфейс один за другим. Этот режим обеспечивает функциональность балансировки нагрузки.

Режим 1 (активное резервное копирование ): в этом режиме активен только один интерфейс, а все остальные интерфейсы находятся в резервном состоянии. Если активный интерфейс выходит из строя, резервный интерфейс заменяет его как единственный активный интерфейс в соединении. Адрес управления доступом к среде (MAC) интерфейса связи в режиме 1 виден только на одном порту (сетевом адаптере), что предотвращает путаницу для коммутатора. Режим 1 обеспечивает отказоустойчивость.

Режим 2 (баланс- исключающее ИЛИ): MAC-адрес источника использует логику исключающего или (XOR) с MAC-адресом назначения. Этот расчет гарантирует, что для каждого MAC-адреса назначения выбирается один и тот же ведомый интерфейс. Режим 2 обеспечивает отказоустойчивость и балансировку нагрузки.

Режим 3 (широковещательный) : Все передачи отправляются всем ведомым устройствам. Этот режим обеспечивает отказоустойчивость.

Режим 4 (802.3ad) : в этом режиме создаются группы агрегации с одинаковыми настройками скорости и дуплекса, и для него требуется коммутатор, поддерживающий динамическую связь IEEE 802.3ad. Режим 4 использует все интерфейсы в активной группе агрегации. Например, вы можете объединить три порта 1 Гбит/с (GBPS) в магистральный порт 3 Гбит/с. Это эквивалентно наличию одного интерфейса со скоростью 3 Гбит/с. Он обеспечивает отказоустойчивость и балансировку нагрузки.

Режим 5 (баланс-tlb) : этот режим гарантирует, что распределение исходящего трафика установлено в соответствии с нагрузкой на каждый интерфейс и что текущий интерфейс получает весь входящий трафик. Если назначенный интерфейс не получает трафик, принимающей роли назначается другой интерфейс. Он обеспечивает отказоустойчивость и балансировку нагрузки.

Режим 6 (balance-alb) : этот режим поддерживается только в средах x86. Полученные пакеты распределяются по нагрузке посредством согласования протокола разрешения адресов (ARP). Этот режим обеспечивает отказоустойчивость и балансировку нагрузки.

[пример настройки бондинга для разных дистрибутивов](http://www.adminia.ru/linux-bonding-obiedinenie-setevyih-interfeysov-v-linux/)
[другой пример настройки бондинга](https://help.ubuntu.com/community/UbuntuBonding)

Пример конфига:
```
# eth0 is manually configured, and slave to the "bond0" bonded NIC
auto eth0
iface eth0 inet manual
    bond-master bond0

# eth1 ditto, thus creating a 2-link bond.
auto eth1
iface eth1 inet manual
    bond-master bond0

# bond0 is the bonded NIC and can be used like any other normal NIC.
# bond0 is configured using static network information.
auto bond0
iface bond0 inet static
    address 192.168.1.10
    gateway 192.168.1.1
    netmask 255.255.255.0

    # bond0 uses standard IEEE 802.3ad LACP bonding protocol
    bond-mode 4
    bond-miimon 100
    bond-lacp-rate 1
    bond-slaves eth0 eth1
```

5. - Сколько IP адресов в сети с маской /29 ? Сколько /29 подсетей можно получить из сети с маской /24. Приведите несколько примеров /29 подсетей внутри сети 10.10.10.0/24.

Маска /29 позволяет испольовать 8 адресов в сети. Два из них зарезервированы под широковещательный адрес и адрес сети. Для устройств можно использовать 6 адресов.
Маска /24 позволяет испольовать 256 адресов в сети. 256/8=32. 
Хотя я не уверен, можно ли занимать широковещательный адрес и адрес сети с маской /24. Тогда у 2_х сетей будет общий широковещательный трафик и у двух сетей общий адрес сети. Дам всё же ответ 30 сетей! Если не использовать маску /24 вообще - тогда 32 влезет.

6. - Задача: вас попросили организовать стык между 2-мя организациями. Диапазоны 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 уже заняты. Из какой подсети допустимо взять частные IP адреса? Маску выберите из расчета максимум 40-50 хостов внутри подсети.

sudo apt-get install ipcalc

Блок с 169.254.1.0 по 169.254.254.255 (подсеть 169.254.0.0/16 за исключением подсетей 169.254.0.0/24 и 169.254.255.0/24) — используется для автоматической настройки сетевого интерфейса в случае отсутствия DHCP.
Вот в эти исключения и можно внедрить подсеть.
```
ipcalc -c -b --split 60 169.254.0.0/24
Address:   169.254.0.0
Netmask:   255.255.255.0 = 24
Wildcard:  0.0.0.255
=>
Network:   169.254.0.0/24
HostMin:   169.254.0.1
HostMax:   169.254.0.254
Broadcast: 169.254.0.255
Hosts/Net: 254                   Class B, APIPA

1. Requested size: 60 hosts
Netmask:   255.255.255.192 = 26
Network:   169.254.0.0/26
HostMin:   169.254.0.1
HostMax:   169.254.0.62
Broadcast: 169.254.0.63
Hosts/Net: 62                    Class B, APIPA

Needed size:  64 addresses.
Used network: 169.254.0.0/26
Unused:
169.254.0.64/26
169.254.0.128/25
```

7. - Как проверить ARP таблицу в Linux, Windows? Как очистить ARP кеш полностью? Как из ARP таблицы удалить только один нужный IP?

windows:
```
arp -a
arp -d IP_ADDRESS
```

linux:
```
ip n
sudo ip neigh del 10.10.10.5
```


--------------------------------------------------------------------------------------------
     
     Алексей Федин отправил(a) решение на доработку 14 февр. в 22:52

Алексей Федин
ПРЕПОДАВАТЕЛЬ
14 февраля 2022 22:52
Добрый день!

Задание 5
Специальные адреса используются только с привязкой к маске, иначе получилось бы так, что для данного задания нужно было удалять адреса для /24 /25 /26 и т.д. Правильный ответ - 32 сети.

Задание 6
Эти адреса категорически нельзя использовать. Нужно поискать немаршрутизируемые диапазоны.

Уточните задание 6 и поставлю зачет.

С уважением,
Алексей

     
По заданию 6 нашел дополнительную информацию:
     [не маршрутизируемые диапазоны интернет](https://www.securitylab.ru/blog/personal/aodugin/305208.php)
     
Самым подходящим считаю диапазон
     198.18.0.0/15
Диапазон выделен под лаборатории нагрузочного тестирования (Benchmarking) в соответствии с RFC2544 и уточнением в RFC6815 , что данный диапазон не должен быть досутпен в Интернет во избежание конфликтов.
Вообще то можно и  100.64.0.0/10
В соответствии с RFC6598 , используется как транслируемый блок адресов для межпровайдерских взаимодействий и Carrier Grade NAT.
Но вцелом это не корректно и провайдер, если увидит такой трафик, должен исследовать причину.



